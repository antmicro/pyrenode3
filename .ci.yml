image: "d2s://external/docker/debian:bookworm"

variables:
  COMMON_DEPS: git autoconf automake coreutils g++ gcc libgtk2.0-0 libtool policykit-1 python3 python3 python3-pip python3-venv screen uml-utilities wget

.install-dependencies: &install_dependencies |-
    apt-get -qqy update &> /dev/null
    apt-get -qqy install ${COMMON_DEPS} ${JOB_DEPS}

.install-dotnet: &install_dotnet |-
    echo "verbose = off" > wgetrc_local
    export WGETRC=wgetrc_local
    wget --progress=dot:giga https://dot.net/v1/dotnet-install.sh -O /dotnet-install.sh
    chmod +x /dotnet-install.sh
    /dotnet-install.sh --version "$DOTNET_VERSION" --install-dir "/opt/dotnet"

.add-dotnet-path: &add_dotnet_path |-
    export PATH="/opt/dotnet:$PATH"
    dotnet --list-sdks
    dotnet --list-runtimes

.init-python: &init_python |-
    python3 -m venv .venv && source .venv/bin/activate
    pip install .
    pip install -r examples/requirements.txt

.run-tests: &run_tests |
  for i in examples/*.py; do echo "Running test $i..."; timeout 240 python3 $i; done

.dotnet-sdk-versions: &dotnet_sdk_versions
  - "6.0.428"
  - "8.0.416"
  - "9.0.307"
  - "10.0.100"

test-mono-pkg:
  stage: build
  tags: ['ace-x86_64']
  variables:
    JOB_DEPS: gtk-sharp2 mono-complete
  script:
    - *install_dependencies
    - *init_python
    # Download Renode pkg
    - wget --progress=dot:giga https://builds.renode.io/renode-latest.pkg.tar.xz
    - export PYRENODE_RUNTIME=mono
    - export PYRENODE_PKG=$PWD/renode-latest.pkg.tar.xz
    - *run_tests

test-installed-pkg:
  stage: build
  tags: ['ace-x86_64']
  variables:
    JOB_DEPS: gtk-sharp2 mono-complete
  script:
    - *install_dependencies
    - *init_python
    # Download and install Renode
    - wget --progress=dot:giga https://builds.renode.io/renode-latest.deb
    - apt-get -y install ./renode-latest.deb
    - *run_tests

.test-dotnet-build:
  stage: build
  tags: ['ace-x86_64']
  variables:
    JOB_DEPS: cmake
  before_script:
    - *install_dependencies
    - DOTNET_VERSION="$CI_PARALLEL_NAME"
    - *install_dotnet
  script:
    - *init_python
    - *add_dotnet_path
    # Build Renode
    - git clone https://github.com/antmicro/renode.git
    - pushd renode && ./build.sh --net && popd
    - export PYRENODE_RUNTIME=coreclr
    - export PYRENODE_BUILD_DIR=$PWD/renode
    - *run_tests

test-dotnet-build:
  extends: .test-dotnet-build
  parallel: *dotnet_sdk_versions

test-dotnet-portable:
  stage: build
  tags: ['ace-x86_64']
  script:
    - *install_dependencies
    - *init_python
    # Download Renode pkg
    - wget --progress=dot:giga https://builds.renode.io/renode-latest.linux-portable-dotnet.tar.gz
    - tar xvf renode-latest.linux-portable-dotnet.tar.gz
    - export PYRENODE_RUNTIME=coreclr
    - export PYRENODE_BIN=$(realpath $PWD/renode_*-dotnet_portable/renode)

.test-dotnet-pkg:
  stage: build
  tags: ['ace-x86_64']
  variables:
    JOB_DEPS: curl jq zip
  before_script:
    - *install_dependencies
    - DOTNET_VERSION="$CI_PARALLEL_NAME"
    - *install_dotnet
  script:
    - *init_python
    - *add_dotnet_path
    - curl -s https://builds.renode.io/renode-latest.linux-dotnet.tar.gz -o renode-dotnet.tar.gz
    - export PYRENODE_RUNTIME=coreclr
    - export PYRENODE_PKG=$PWD/renode-dotnet.tar.gz
    - *run_tests

test-dotnet-pkg:
  extends: .test-dotnet-pkg
  parallel: *dotnet_sdk_versions

test-mono-build:
  stage: build
  tags: ['ace-x86_64']
  variables:
    JOB_DEPS: cmake gtk-sharp2 mono-complete
  script:
    - *install_dependencies
    - *init_python
    # Build Renode
    - git clone https://github.com/antmicro/renode.git
    - pushd renode && ./build.sh --mono && popd
    - export PYRENODE_RUNTIME=mono
    - export PYRENODE_BUILD_DIR=$(pwd)/renode
    - *run_tests

test-macos-mono-build:
  stage: build
  tags: ['renode-macos']
  script:
    - *init_python
    - git clone https://github.com/antmicro/renode.git
    - pushd renode && ./build.sh --mono && popd
    - export PYRENODE_RUNTIME=mono
    - export PYRENODE_BUILD_DIR=$(pwd)/renode
    - *run_tests
